AbsorbSpellDB = {
    ["WARLOCK"] = {
        {name = "Shadow Ward", rank = "Rank 1", absorbType = "shadow"},
        {name = "Shadow Ward", rank = "Rank 2", absorbType = "shadow"},
        {name = "Shadow Ward", rank = "Rank 3", absorbType = "shadow"},
        {name = "Sacrifice", rank = "Rank 1", absorbType = "all"},
        {name = "Sacrifice", rank = "Rank 2", absorbType = "all"},
        {name = "Sacrifice", rank = "Rank 3", absorbType = "all"},
        {name = "Sacrifice", rank = "Rank 4", absorbType = "all"},
        {name = "Sacrifice", rank = "Rank 5", absorbType = "all"},
        {name = "Sacrifice", rank = "Rank 6", absorbType = "all"},
    },
    ["MAGE"] = {
        {name = "Fire Ward", rank = "Rank 1", absorbType = "fire"},
        {name = "Fire Ward", rank = "Rank 2", absorbType = "fire"},
        {name = "Fire Ward", rank = "Rank 3", absorbType = "fire"},
        {name = "Fire Ward", rank = "Rank 4", absorbType = "fire"},
        {name = "Fire Ward", rank = "Rank 5", absorbType = "fire"},
        {name = "Frost Ward", rank = "Rank 1", absorbType = "frost"},
        {name = "Frost Ward", rank = "Rank 2", absorbType = "frost"},
        {name = "Frost Ward", rank = "Rank 3", absorbType = "frost"},
        {name = "Frost Ward", rank = "Rank 4", absorbType = "frost"},
        {name = "Frost Ward", rank = "Rank 5", absorbType = "frost"},
        {name = "Ice Barrier", rank = "Rank 1", absorbType = "all"},
        {name = "Ice Barrier", rank = "Rank 2", absorbType = "all"},
        {name = "Ice Barrier", rank = "Rank 3", absorbType = "all"},
        {name = "Ice Barrier", rank = "Rank 4", absorbType = "all"},
        {name = "Mana Shield", rank = "Rank 1", absorbType = "physical"},
        {name = "Mana Shield", rank = "Rank 2", absorbType = "physical"},
        {name = "Mana Shield", rank = "Rank 3", absorbType = "physical"},
        {name = "Mana Shield", rank = "Rank 4", absorbType = "physical"},
        {name = "Mana Shield", rank = "Rank 5", absorbType = "physical"},
        {name = "Mana Shield", rank = "Rank 6", absorbType = "physical"},
        {name = "Ice Block", value = "immunity", absorbType = "all"},
    },
    ["PALADIN"] = {
        {name = "Divine Protection", rank = "Rank 1", value = "immunity", absorbType = "all"},
        {name = "Divine Protection", rank = "Rank 2", value = "immunity", absorbType = "all"},
        {name = "Divine Shield", rank = "Rank 1", value = "immunity", absorbType = "all"},
        {name = "Divine Shield", rank = "Rank 2", value = "immunity", absorbType = "all"},
    },
    {name = "Power Word: Shield", rank = "Rank 1", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 2", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 3", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 4", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 5", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 6", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 7", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 8", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 9", absorbType = "all"},
    {name = "Power Word: Shield", rank = "Rank 10", absorbType = "all"},
    {name = "Blessing of Protection", rank = "Rank 1", value = "immunity", absorbType = "physical"},
    {name = "Blessing of Protection", rank = "Rank 2", value = "immunity", absorbType = "physical"},
    {name = "Blessing of Protection", rank = "Rank 3", value = "immunity", absorbType = "physical"},
    {name = "Holy Protection", absorbType = "holy"}, --greater-holy-protection-potion
    {name = "Fire Protection", absorbType = "fire"}, --greater-fire-protection-potion
    {name = "Frost Protection", absorbType = "frost"}, --greater-frost-protection-potion
    {name = "Shadow Protection", absorbType = "shadow"}, --greater-shadow-protection-potion
    {name = "Nature Protection", absorbType = "nature"}, --greater-nature-protection-potion
    {name = "Arcane Protection", absorbType = "arcane"}, --greater-arcane-protection-potion
    {name = "Invulnerability", absorbType = "physical"}, --limited-invulnerability-potion
    {name = "Petrification", absorbType = "all"}, --flask-of-petrification
    {name = "Light of Elune", absorbType = "all"}, --light-of-elune
    {name = "Fire Protection", absorbType = "fire"}, --}frozen-rune
    {name = "Persistent Shield", absorbType = "all"}, --}frozen-rune
    {name = "Physical Protection", absorbType = "physical"},
    {name = "The Burrower's Shell", absorbType = "all"},
    {name = "Uther's Light Effect", absorbType = "all"},
    {name = "Aura of Protection", absorbType = "all"},
    {name = "Frost Resistance", absorbType = "frost"},
    {name = "Persistent Shield", absorbType = "all"},
    {name = "Fire Resistance", absorbType = "fire"},
    {name = "Damage Absorb", absorbType = "physical", level = "28"},
    {name = "Damage Absorb", absorbType = "physical", level = "38"},
    {name = "Damage Absorb", absorbType = "physical", level = "48"},
    {name = "Damage Absorb", absorbType = "physical", level = "58"},
    {name = "Damage Absorb", absorbType = "physical", level = "28"},
    {name = "Damage Absorb", absorbType = "physical", level = "38"},
    {name = "Damage Absorb", absorbType = "physical", level = "48"},
    {name = "Damage Absorb", absorbType = "physical", level = "58"},
    {name = "Fire Protection", rank= "Rank 1", absorbType = "fire"},
    {name = "Mark of the Dragon Lord", absorbType = "all"},
    {name = "Elemental Protection", absorbType = "magic"},
    {name = "Harm Prevention Belt", absorbType = "all"},
    {name = "Greater Spellstone", absorbType = "magic"},
    {name = "Major Spellstone", absorbType = "magic"},
    {name = "Jang'thraze", absorbType = "physical"},
    {name = "Divine Protection", value = "350", absorbType = "all"},
    {name = "Holy Shield", value = "175", absorbType = "all"},
    {name = "Spellstone", absorbType = "magic", i},
}

AbsorbItemDB = {
    {item = "Limited Invulnerability Potion", name = "Invulnerability", value = "immunity", absorbType = "physical", itemID = "3387"},
    {item = "Holy Protection Potion", name = "Holy Protection", rank = "Rank 1", absorbType = "holy", itemID = "6051"},
    {item = "Fire Protection Potion", name = "Fire Protection", rank = "Rank 4", absorbType = "fire", itemID = "6049"},
    {item = "Nature Protection Potion", name = "Nature Protection", rank = "Rank 5", absorbType = "nature", itemID = "6052"},
    {item = "Frost Protection Potion", name = "Frost Protection", rank = "Rank 5", absorbType = "frost", itemID = "6050"},
    {item = "Shadow Protection Potion", name = "Shadow Protection", rank = "Rank 3", absorbType = "shadow", itemID = "6048"},
    {item = "Greater Holy Protection Potion", name = "Holy Protection", absorbType = "holy", itemID = "13460"},
    {item = "Greater Fire Protection Potion", name = "Fire Protection", absorbType = "fire", itemID = "13457"},
    {item = "Greater Nature Protection Potion", name = "Nature Protection", absorbType = "nature", itemID = "13458"},
    {item = "Greater Frost Protection Potion", name = "Frost Protection", absorbType = "frost", itemID = "13456"},
    {item = "Greater Shadow Protection Potion", name = "Shadow Protection", absorbType = "shadow", itemID = "13459"},
    {item = "Greater Arcane Protection Potion", name = "Arcane Protection", absorbType = "arcane", itemID = "13461"},
    {item = "Flask of Petrification", name = "Petrification", value = "immunity", absorbType = "all", itemID = "13506"},
    {item = "Light of Elune", name = "Light of Elune", value = "immunity", absorbType = "all", itemID = "5816"},
    {item = "Frozen Rune", name = "Fire Protection", absorbType = "fire", itemID = "22682"},
    {item = "The Burrower's Shell", name = "The Burrower's Shell", absorbType = "all", itemID = "23558"},
    {item = "Scarab Brooch", name = "Persistent Shield", absorbType = "all", itemID = "21625"},
    {item = "Mark of Resolution", name = "Physical Protection", absorbType = "physical", itemID = "17759"},
    {item = "Arena Grand Master", name = "Aura of Protection", absorbType = "all", itemID = "19024"},
    {item = "Uther's Strength", name = "Uther's Light Effect", absorbType = "all", itemID = "11302"},
    {item = "Ice Deflector", name = "Frost Resistance", absorbType = "frost", itemID = "4386"},
    {item = "Flame Deflector", name = "Fire Resistance", absorbType = "fire", itemID = "4376"},
    {item = "Talisman of Arathor", name = "Damage Absorb", absorbType = "physical", level = "28", itemID = "21119"},
    {item = "Talisman of Arathor", name = "Damage Absorb", absorbType = "physical", level = "38", itemID = "21118"},
    {item = "Talisman of Arathor", name = "Damage Absorb", absorbType = "physical", level = "48", itemID = "21117"},
    {item = "Talisman of Arathor", name = "Damage Absorb", absorbType = "physical", level = "58", itemID = "20071"},
    {item = "Defiler's Talisman", name = "Damage Absorb", absorbType = "physical", level = "28", itemID = "21120"},
    {item = "Defiler's Talisman", name = "Damage Absorb", absorbType = "physical", level = "38", itemID = "21116"},
    {item = "Defiler's Talisman", name = "Damage Absorb", absorbType = "physical", level = "48", itemID = "21115"},
    {item = "Defiler's Talisman", name = "Damage Absorb", absorbType = "physical", level = "58", itemID = "20072"},
    {item = "Mark of the Dragon Lord", name = "Mark of the Dragon Lord", absorbType = "all", itemID = "13143"},
    {item = "Jang'thraze the Protector", name = "Jang'thraze", absorbType = "physical", itemID = "11086"},
    {item = "Truesilver Champion", name = "Holy Shield", value = "175", absorbType = "all", itemID = "7960"},
    {item = "Goblin Construction Helmet", name = "Fire Protection", rank= "Rank 1", absorbType = "fire", itemID = "10543"},
    {item = "Gnomish Harm Prevention Belt", name = "Harm Prevention Belt", absorbType = "all", itemID = "10721"},
    {item = "Vestments of the Devout", name = "Divine Protection", absorbType = "all", setID = "182"},
    {item = "Vestments of the Virtuous", name = "Divine Protection", absorbType = "all", setID = "514"},
    {item = "Dragonscale Breastplate", name = "Elemental Protection", absorbType = "magic", itemID = "8367"},
    {item = "Greater Spellstone", name = "Greater Spellstone", absorbType = "magic", itemID = "13602"},
    {item = "Major Spellstone", name = "Major Spellstone", absorbType = "magic", itemID = "13603"},
    {item = "Spellstone", name = "Spellstone", absorbType = "magic", itemID = "5522"},
}

schools = {
    [0] = {"physical", "1, 1, 1, 1"},           --"|cFFFFFFFF"
    [1] = {"holy", "1, 0.95, 0.45, 1"},         --"|cFFFFEFC8" FFE6D058
    [2] = {"fire", "1, 0.2, 0, 1"},             --"|cFFFF6304" FFF03D06
    [3] = {"nature", "0.4, 0.9, 0.09, 1"},      --"|cFF65EC16" FF08EC00
    [4] = {"frost", "0, 0.95, 1, 1"},           --"|cFF00F6FF" FF00ECE0
    [5] = {"shadow", "0.4, 0.45, 0.95, 1"},     --"|cFF8A55CE" FF766DFF
    [6] = {"arcane", "0.65, 0.4, 0.95, 1"},     --"|cFF76CEC0" 0.3, 0.4, 1 FBB75FC
}

local SELECT_SHIELD = "SELECT_SHIELD"
local ACTIVATE_NEW_SHIELD = "ACTIVATE_NEW_SHIELD"
local DELETE = "DELETE"
local UPDATE = "UPDATE"
local CHANGED = "CHANGED"
local ADD_PET_SHIELD = "ADD_PET_SHIELD"

local ITEM = "ITEM"
local SPELL ="SPELL"
local MINMAX = "(%d+) to (%d+)"
local VALUE = "(%d+)"
local DMG_TEXT_CHECK = "(damage)"
local SACRIFICE = "by (%aacrifice)"
local IMMUNITY = "immunity"
local PALADIN = "PALADIN"
local WARLOCK = "WARLOCK"
local MAGE = "MAGE"
local PLAYER = "player"
local PET = "pet"

local ActivatedShieldsTable = nil
local CurrentShieldsSet = nil
local DisplayValueTab = nil
local SelectedShield = nil
local PetShield = nil

local DisplayeDivs = 20
local ComputedDivs = 20
local MAX_ELEMENTS = 20
local DivCost = 0


function ActionCreator(action, payload)
    print("CREATOR "..action)
    tabPrint(payload)
    return {
        action,
        payload
    }
end

function ManagePlayerActivity_ShieldMania(action)
    local actionName = action[1]
    local payload = action[2]

    if (actionName == SELECT_SHIELD) then
        local spellName = GameTooltipTextLeft1:GetText()
        local _, className = UnitClass(PLAYER)
        print("Spell |cff9a5bde"..tostring(spellName).."|r selected")
        SelectedShield = GetSpell_ShieldMania(spellName, className)
        if(SelectedShield) then tabPrint(SelectedShield) end

    elseif (actionName == ACTIVATE_NEW_SHIELD) then
        ActivatedShieldsTable = AddActivatedShield_ShieldMania(SelectedShield, ActivatedShieldsTable)
        CurrentShieldsSet = CalculateValues_ShieldMania(ActivatedShieldsTable)
        this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")

        -- print(ActivatedShieldsTable)
        -- tabPrint(ActivatedShieldsTable)
        -- print(CurrentShieldsSet)

    elseif (actionName == UPDATE) then
    elseif (actionName == DELETE) then
    elseif (actionName == CHANGED) then
    end
end

function ParseSpellBook_ShieldMania(startIndex, endIndex, bookType)
    local shield = {}
    for i = startIndex, endIndex do
        local splName, splRank = GetSpellName(i, bookType)
        for _, val in pairs(AbsorbSpellDB.WARLOCK) do
            if (splName == val.name and splRank == val.rank) then

                ShieldManiaTooltip:SetSpell(i, bookType)
                local _, _, spellValue = string.find(tostring(ShieldManiaTooltipTextLeft4:GetText()), "(%d+)")
                shield = {
                    name = splName,
                    rank = splRank,
                    value = spellValue,
                    absorbType = val.absorbType,
                }
                print(splName .."(".. splRank ..") >> absorb |cFFFFE90B[".. tostring(spellValue) .."]|r ".. val.absorbType .." damage")
            end
        end
    end
    return shield
end

function Accummulator_ShieldMania(list)
    local sumValue = 0
    for i, elem in pairs(list) do
        if (elem.value == "immunity") then 
            sumValue = IMMUNITY
            return sumValue
        else
            sumValue = sumValue + elem.value
            return sumValue
        end
    end
end


-- works with active table
function GetSpell_ShieldMania(spellName, className)
    local tooltips = {
        [1] = GameTooltipTextLeft1,
        [2] = GameTooltipTextLeft2,
        [3] = GameTooltipTextLeft3,
        [4] = GameTooltipTextLeft4,
        [5] = GameTooltipTextLeft5,
        [6] = GameTooltipTextLeft6,
        [7] = GameTooltipTextLeft7,
    }
    local shieldValue, maxValue

    if (className == MAGE or className == PALADIN or className == WARLOCK) then
        if (className == WARLOCK) then
            if (HasPetUI()) then
                local petSpellsNum, petType = HasPetSpells()
                PetShield = ParseSpellBook_ShieldMania(1, petSpellsNum, PET)
                this:RegisterEvent("PET_DISMISS_START")
                this:UnregisterEvent("SPELL_UPDATE_USABLE")
            else
                this:RegisterEvent("UNIT_PET")
            end
        end
        for i, shield in pairs(AbsorbSpellDB[className]) do
            if (spellName == shield.name) then
                print("GetSpell: SPELL FOUND |cFF1FF63ETRUE|r |cff62a2f0"..shield.name)
                if (shield.value) then
                    shieldValue = shield.value
                else
                    _, _, shieldValue = string.find(tostring(GameTooltipTextLeft4:GetText()), VALUE)
                end
                this:UnregisterEvent("CURRENT_SPELL_CAST_CHANGED")
                this:RegisterEvent("SPELL_UPDATE_USABLE")

                return {
                    name = spellName,
                    rank = GameTooltipTextRight1:GetText(),
                    value = shieldValue,
                    absorbType = shield.absorbType
                }
            end
        end
    else
        for i, shield in pairs(AbsorbSpellDB) do
            if (spellName == shield.name) then
                print("GetSpell: SPELL FOUND |cFF1FF63ETRUE|r |cff62a2f0"..shield.name)
                if (shield.value) then
                    shieldValue = shield.value
                else
                    _, _, shieldValue = string.find(tostring(GameTooltipTextLeft4:GetText()), VALUE)
                end
                this:UnregisterEvent("CURRENT_SPELL_CAST_CHANGED")
                this:RegisterEvent("SPELL_UPDATE_USABLE")

                return {
                    name = spellName,
                    rank = GameTooltipTextRight1:GetText(),
                    value = shieldValue,
                    absorbType = shield.absorbType
                }
            end
        end
    end
    for i, shield in pairs(AbsorbItemDB) do
        if (spellName == shield.item) then
            print("GetSpell: SPELL FOUND |cFF1FF63ETRUE|r |cff62a2f0"..shield.name)
            if (shield.value) then
                shieldValue = shield.value
            else
                for j = 2, GameTooltip:NumLines() do
                    _, _, arg = string.find(tostring(tooltips[j]:GetText()), DMG_TEXT_CHECK)
                    if (arg) then
                        print(j .."".. arg)
                        _, _, shieldValue, maxValue = string.find(tostring(tooltips[j]:GetText()), MINMAX)
                        print("shieldValue "..tostring(shieldValue))
                        print("shieldValue "..tostring(maxValue))
                        if (not shieldValue) then
                            _, _, shieldValue = string.find(tostring(tooltips[j]:GetText()), VALUE)
                        end
                    end
                end
            end
            this:UnregisterEvent("CURRENT_SPELL_CAST_CHANGED")
            this:RegisterEvent("SPELLCAST_STOP")
            return {
                name = shield.name,
                rank = shield.rank,
                value = shieldValue,
                maxValue = maxValue,
                absorbType = shield.absorbType,
            }
        end
    end
    print("SPELL NOT FOUND |cFFFF0000FAlSE|r")
    return false
end

function AddActivatedShield_ShieldMania(newShield, activatedShieldsTable)
    print("AddActivatedShield_ShieldMania ENTERB")
    if ((not activatedShieldsTable) and newShield) then
        activatedShieldsTable = {}
        activatedShieldsTable[newShield.absorbType] = {}

        table.insert(activatedShieldsTable[newShield.absorbType], newShield)
        SelectedShield = nil
        return activatedShieldsTable

    elseif ((tabLength(activatedShieldsTable) > 0) and newShield) then
        for absorbType, shieldList in pairs(activatedShieldsTable) do
            if (newShield.absorbType == absorbType) then
                for i, oldShield in pairs(shieldList) do
                    if (newShield.name == oldShield.name) then
                        shieldList[i] = newShield
                        SelectedShield = nil
                        return activatedShieldsTable
                    else
                        table.insert(shieldList, newShield)
                        SelectedShield = nil
                        return activatedShieldsTable
                    end
                end
            else
                activatedShieldsTable[newShield.absorbType] = {}
                table.insert(activatedShieldsTable[newShield.absorbType], newShield)
                SelectedShield = nil
                return activatedShieldsTable
            end
        end
    end
end

function DeleteDiactivatedShield_ShieldMania(auraName, activatedShieldsTable)
    if (activatedShieldsTable) then
        for absorbType, shieldList in pairs(activatedShieldsTable) do
            for i, aura in pairs(shieldList) do
                if (auraName == aura.name) then
                    table.remove(shieldList, i)
                end
            end
        end
    end
end

-- works with calculated table
function CalculateValues_ShieldMania(activatedShieldsTable)
    local shieldSetTab = {}
    for absorbType, shieldList in pairs(activatedShieldsTable) do
        print("CalculateValues_ShieldMania "..absorbType)
        shieldSetTab[absorbType] = Accummulator_ShieldMania(shieldList)
        print("CalculateValues_ShieldMania "..absorbType.." = "..shieldSetTab[absorbType])
    end
    if (shieldSetTab.all ~= IMMUNITY and (shieldSetTab.all or shieldSetTab.magic)) then
        DisplayValueTab = (shieldSetTab.all or 0) + (shieldSetTab.magic or 0)
        DivCost = DisplayValueTab / MAX_ELEMENTS
    end
    return shieldSetTab
end

function ChangedShieldSetTab_ShieldMania(damage)
    local shieldSetTab = {}
    if (ShieldSize.all and ShieldSize.all > 0) then
        ShieldSize.all = ShieldSize.all - arg[1]
        print(ShieldSize.all)
        if (DisplayedElements <= 0) then
            return
        else 
            frame.ShieldText:SetText(ShieldSize.all)
        end

        for i = DisplayedElements, (DisplayedElements - math.floor(arg[1] / ElementCost)), -1 do
            frame.ElementList[i]:Hide()
        end
        ComputedElements = ComputedElements - arg[1] / ElementCost
        DisplayedElements = math.ceil(ComputedElements)
    end
end

--works with Display
function InitializationMainDysplay(frame)
    frame.Tracker = {}
    frame.Tracker.ImmunityBar = CreateFrame("StatusBar", nil, frame)
    frame.Tracker.ImmunityBar:SetOrientation("vertical")
    frame.Tracker.ImmunityBar:SetPoint("BOTTOM", 110, 0)
    frame.Tracker.ImmunityBar:SetHeight(140)
    frame.Tracker.ImmunityBar:SetWidth(24)
    frame.Tracker.ImmunityBar:SetStatusBarTexture("Interface\\TARGETINGFRAME\\UI-StatusBar")
    -- frame.Tracker.ImmunityBar:SetStatusBarColor(0.8, 1, 1, 1)
    frame.Tracker.ImmunityBar:Hide()

    frame.Tracker.DivisionList = {}
    local axisY = 0

    for i = 1, 20 do
        frame.Tracker.DivisionList[i] = frame:CreateTexture(nil, "ARTWORK")
        frame.Tracker.DivisionList[i]:SetTexture(0.9, 0.8, 0.45, 0.6)  --0, 1, 0
        frame.Tracker.DivisionList[i]:SetWidth(24)
        frame.Tracker.DivisionList[i]:SetHeight(4)
        frame.Tracker.DivisionList[i]:SetPoint("BOTTOM", 110, axisY)
        frame.Tracker.DivisionList[i]:Hide()
        axisY = axisY + 7
    end
    
    frame.Tracker.ShieldText = frame:CreateFontString(nil, "ARTWORK", "GameFontNormal")
    frame.Tracker.ShieldText:SetPoint("BOTTOM", 110, -22)
    frame.Tracker.ShieldText:SetFont("Fonts\\FRIZQT__.TTF", 20)
    frame.Tracker.ShieldText:Hide()
end

function InitializationStatusBars(frame)
    frame.Tracker.Bars = {}
    frame.Tracker.BarValues = {}
    frame.Tracker.BarNameText = {}
    frame.Tracker.BarNameplates = {}

    for i, item in pairs(schools) do
        frame.Tracker.Bars[item[1]] = CreateFrame("StatusBar", nil, frame)
        frame.Tracker.Bars[item[1]]:SetPoint("CENTER", 200)
        frame.Tracker.Bars[item[1]]:SetHeight(12)
        frame.Tracker.Bars[item[1]]:SetWidth(55)
        frame.Tracker.Bars[item[1]]:SetStatusBarTexture("Interface\\TARGETINGFRAME\\UI-StatusBar")
        frame.Tracker.Bars[item[1]]:Hide()
        
        frame.Tracker.BarNameplates[item[1]] = CreateFrame("Frame", nil, UIParent)
        frame.Tracker.BarNameplates[item[1]]:SetWidth(20)
        frame.Tracker.BarNameplates[item[1]]:SetHeight(12)
        frame.Tracker.BarNameplates[item[1]]:SetPoint("CENTER", frame.Tracker.Bars[item[1]],  0, 0)
        
        frame.Tracker.BarNameText[item[1]] = frame:CreateFontString(nil, "OVERLAY", "GameFontNormal")
        frame.Tracker.BarNameText[item[1]]:SetPoint("BOTTOM", frame.Tracker.BarNameplates[item[1]])
        frame.Tracker.BarNameText[item[1]]:SetFont("Fonts\\FRIZQT__.TTF", 12)
        frame.Tracker.BarNameText[item[1]]:Hide()

        frame.Tracker.BarValues[item[1]] = frame:CreateFontString(nil, "OVERLAY", "GameFontNormal")
        frame.Tracker.BarValues[item[1]]:SetPoint("BOTTOM", frame.Tracker.Bars[item[1]])
        frame.Tracker.BarValues[item[1]]:SetFont("Fonts\\FRIZQT__.TTF", 12)
        frame.Tracker.BarValues[item[1]]:Hide()
    end
end

function ShowMainDisplay_ShieldMania(frame, shieldSetTab)
    if (shieldSetTab.all == IMMUNITY) then
        frame.Tracker.ImmunityBar:SetStatusBarColor(0.9, 0.8, 0.45, 0.5)
        frame.Tracker.ImmunityBar:SetMinMaxValues(100, 100)
        frame.Tracker.ImmunityBar:SetValue(100)
        frame.Tracker.ImmunityBar:Show()
        frame.Tracker.ShieldText:SetText(shieldSetTab.all)
    else
        for i, div in pairs(frame.Tracker.DivisionList) do
            div:Show()
        end
        frame.Tracker.ShieldText:SetText(DisplayValueTab)
    end
    frame.Tracker.ShieldText:Show()
end

function HideMainDisplay_ShieldMania()
    if (shieldSetTab.all == IMMUNITY) then
        frame.Tracker.ImmunityBar:Hide()
    else
        for i, div in pairs(frame.Tracker.DivisionList) do
            div:Hide()
        end
    end
    frame.Tracker.ShieldText:SetText("")
    frame.Tracker.ShieldText:Hide()
end

function ShowStatusBars_ShieldMania(frame)
    local axisy = -8
    for absorbType, val in pairs(CurrentShieldsSet) do
        for i, statusBar in pairs(frame.Tracker.Bars) do
            for j, school in pairs(schools) do
                if (absorbType == i and i == school[1]) then
                    print(absorbType .."/".. i .."/".. school[1])
                    local _, _, r, g, b = string.find(s[2], "(.+),%s(.+),%s(.+),%s")

                    frame.Tracker.Bars[school[1]]:SetPoint("CENTER", 200, axisy)
                    frame.Tracker.Bars[school[1]]:SetStatusBarColor(tonumber(r), tonumber(g), tonumber(b), 0.5)
                    if (val == IMMUNITY) then
                        frame.Tracker.Bars[school[1]]:SetMinMaxValues(100, 100)
                        frame.Tracker.Bars[school[1]]:SetValue(100)
                    else
                        frame.Tracker.Bars[school[1]]:SetMinMaxValues(0, val)
                        frame.Tracker.Bars[school[1]]:SetValue(val)
                    end
                    frame.Tracker.Bars[school[1]]:Show()

                    frame.Tracker.BarNameText[school[1]]:SetPoint("CENTER", frame.Tracker.BarNameplates[school[1]], 0, 0)
                    frame.Tracker.BarNameText[school[1]]:SetText(school[1])
                    frame.Tracker.BarNameText[school[1]]:SetTextColor(1, 1, 1, 1)
                    frame.Tracker.BarNameText[school[1]]:Show()

                    frame.Tracker.BarValues[school[1]]:SetPoint("BOTTOM", frame.Tracker.BarNameplates[school[1]], 0, -12)
                    frame.Tracker.BarValues[school[1]]:SetText(val)
                    frame.Tracker.BarValues[school[1]]:SetTextColor(r, g, b, 1)
                    frame.Tracker.BarValues[school[1]]:Show()
                    axisy = axisy - 25
                end
            end
        end
    end
end

function HideStatusBars_ShieldMania(frame)
    for i, statusBar in pairs(frame.Tracker.Bars) do
        statusBar:Hide()
        frame.Tracker.BarNameText[i]:Hide()
        frame.Tracker.BarValues[i]:Hide()
    end
end


function SM_OnLoad()
    local textureFrame = this:CreateTexture(nil, "BACKGROUND")
    textureFrame:SetAllPoints()
    textureFrame:SetTexture(1, 0, 0, 0.1)
    print("ShieldMania |cff00AAFFloaded")

    InitializationMainDysplay(this)
    InitializationStatusBars(this)

    this:RegisterEvent("PLAYER_ENTERING_WORLD")
    this:RegisterEvent("PLAYER_ENTER_COMBAT")
    this:RegisterEvent("PET_DISMISS_START")
    this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")
    this:RegisterEvent("CHAT_MSG_SPELL_PET_DAMAGE")
    this:RegisterEvent("SPELLCAST_STOP")
    this:RegisterEvent("SPELLCAST_FAILED")
    this:RegisterEvent("UNIT_COMBAT")
    this:RegisterEvent("CHAT_MSG_SPELL_CREATURE_VS_CREATURE_DAMAGE")
    this:RegisterEvent("CHAT_MSG_SPELL_CREATURE_VS_SELF_MISSES")
    this:RegisterEvent("CHAT_MSG_SPELL_SELF_BUFF")
    this:RegisterEvent("CHAT_MSG_COMBAT_CREATURE_VS_SELF_MISSES")
    this:RegisterEvent("CHAT_MSG_SPELL_PERIODIC_SELF_BUFFS")
    this:RegisterEvent("COMBAT_TEXT_UPDATE")

end

function SM_OnEvent()
    if (event == "PLAYER_ENTERING_WORLD") then
        this:RegisterEvent("UNIT_MODEL_CHANGED")
        this:UnregisterEvent("PLAYER_ENTERING_WORLD")

    elseif(event == "UNIT_PET") then
        this:UnregisterEvent("UNIT_PET")
        this:RegisterEvent("SPELL_UPDATE_USABLE")
        this:RegisterEvent("PET_DISMISS_START")

    elseif(event == "PET_DISMISS_START") then
        this:RegisterEvent("UNIT_PET")

    elseif(event == "CHAT_MSG_SPELL_PET_DAMAGE") then
        print("CHAT_MSG_SPELL_PET_DAMAGE" .."|cFFFFED27".. arg1)
        local _, _, name = string.find(arg1, "by (%aacrifice)")
        print("|cFFFFE90B"..tostring(name))
        if (name) then
            print("|cFFFFE90B" .. name)
            ShieldMania_ActivatedShieldTable = ShieldMania_AddNewShield(ShieldMania_PetShield)
            ShieldMania_CurrentShieldSet =  ShieldMania_CalculateShieldSet(ShieldMania_ActivatedShieldTable)
            for i, v in pairs(ShieldMania_PetShield) do
                if (v == name) then
                    print(i.."|cFFF66410 "..v)
                    this:RegisterEvent("UNIT_PET")
                    this:UnregisterEvent("SPELL_UPDATE_USABLE")
                end
            end
        end

    elseif(event == "CURRENT_SPELL_CAST_CHANGED") then
        ManagePlayerActivity_ShieldMania( ActionCreator(SELECT_SHIELD) )

    elseif(event == "SPELLCAST_STOP") then
    print("SPELLCAST_STOP")
        ManagePlayerActivity_ShieldMania( ActionCreator(ACTIVATE_NEW_SHIELD) )
        -- if (ShieldMania_SelectedShield) then
        --     ShieldMania_ActivatedShieldTable = ShieldMania_AddNewShield(ShieldMania_SelectedShield, ShieldMania_ActivatedShieldTable)
        --     ShieldMania_CurrentShieldSet =  ShieldMania_CalculateShieldSet(ShieldMania_ActivatedShieldTable)
        -- end
        --     this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")

    elseif(event == "SPELLCAST_FAILED") then
        this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")

    elseif(event == "SPELL_UPDATE_USABLE") then
        this:UnregisterEvent("SPELL_UPDATE_USABLE")
        print("SPELL_UPDATE_USABLE")
        this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")

        local _, classPlayer = UnitClass("player")
        print("|cFF8788EE"..classPlayer)
        print("I'M ENTERED HERE")
        if (classPlayer == "WARLOCK" and HasPetUI()) then
            ShieldMania_PetShield = ShieldMania_GetPetShield(classPlayer)
            for i , v in pairs(ShieldMania_PetShield) do
                print(i .."<>|cFF8788EE".. v)
            end
        elseif (classPlayer == "WARLOCK" and (not HasPetUI())) then
            print("|cff00d4c5ПЕТ ПАНЕЛИ НЕТ")
            this:RegisterEvent("UNIT_PET")

    elseif(event == "CHAT_MSG_SPELL_SELF_BUFF") then
        -- this:UnregisterEvent("ITEM_LOCK_CHANGED")
        print("CHAT_MSG_SPELL_SELF_BUFF " ..tostring(arg1) ..tostring(arg2))

    elseif(event == "CHAT_MSG_SPELL_PERIODIC_SELF_BUFFS") then
        local _, _, spellName = string.find(arg1, "You gain (.+).")
        
        for absorbType, tab in pairs(ShieldMania_ActivatedShieldTable) do
            for absType, value in pairs(ShieldMania_CurrentShieldSet) do
                print(string.upper(absorbType))
                if(absorbType == absType and absType == "all") then
                    ShieldSize = ShieldMania_CurrentShieldSet
                    ElementCost = ShieldSize.all / MAX_ELEMENTS
                    print(ShieldSize.all)
                end
                for j, spell in pairs(tab) do
                    if (spell.name == spellName) then
                        print(spellName..spell.rank)
                    end
                    ShieldMania_ShowShieldDisplay(this)
                    this:RegisterEvent("CHAT_MSG_SPELL_AURA_GONE_SELF")
                    print("|cFF26F6CDCHAT_MSG_SPELL_AURA_GONE_SELF")
                end
            end
        end

        if (ShieldMania_CurrentShieldSet) then InitialStatusBars_ShieldMania(this) end

    elseif(event == "CHAT_MSG_SPELL_AURA_GONE_SELF") then
        local _, _, spellName = string.find(arg1, "^(.+) fades")
        
        for absorbType, tab in pairs(ShieldMania_ActivatedShieldTable) do
            for i, spell in pairs(tab) do
                if (spell.name == spellName) then
                    print(spellName..spell.rank)
                    DisplayedElements = 20
                    ComputedElements = 20
                    ShieldMania_HideShieldDisplay(this)
        
                    this:UnregisterEvent("CHAT_MSG_SPELL_AURA_GONE_SELF")
                    print("|cFFF6D18DCHAT_MSG_SPELL_AURA_GONE_SELF")
                    this:RegisterEvent("CURRENT_SPELL_CAST_CHANGED")
                end
            end
        end
    elseif(event == "UNIT_COMBAT") then
        print("UNIT_COMBAT |cFFFFED27".. arg1 .." / ".. arg2 .." / ".. arg3 .." / ".. arg4 .." / "..arg5)
        if (arg3 == "ABSORB") then
            local dmgMin, dmgMax, offMin, offMax = UnitDamage("target")
            local mainDmg = math.random(dmgMin,dmgMax) or 0
            local offDmg = math.random(offMin, offMax) or 0
            print("DAMAGE "..tostring(mainDmg))
            ShieldMania_UpdateShieldDisplay(this, mainDmg)
        end
    end
end
end

combat_instance = {
    COMBAT = true,
    enemy_stat = {

         
    }
}

function dmg()
    if (offMin) then
        enemy.name = UnitName()
        enemy.main_hand = true
        if (enemy.main_hand == true) then
            dmg = math.random(dmgMin,dmgMax) or 0
            enemy.main_hand = false
        elseif (enemy.main_hand == false) then
            dmg = math.random(offMin,offMax) or 0
            enemy.main_hand = true
        end
    else
        dmg = math.random(dmgMin,dmgMax) or 0
    end
        update_shieldmania(this, dmg)
end
-- {
--     UnitName(),
--     main_hand = true,

-- }

function print(arg)
	DEFAULT_CHAT_FRAME:AddMessage("|cffCC121Ddebug|r " .. tostring(arg))
end

function ___(value)
    if (type(value) == "table") then
        tblCopy = {}
        for i, v in pairs(value) do
            tblCopy[i] = ___(v)
        end
        return tblCopy
    else
        return value
    end
end

function tabLength(tabl)
    local counter = 0
    if (type(tabl) == "table") then
        for i, v in pairs(tabl) do
            counter = counter + 1
        end
    else
        counter = 0
    end
    return counter
end

function tabPrint(arg)
    if (type(arg) == "table") then
        for i, v in pairs(arg) do
            -- DEFAULT_CHAT_FRAME:AddMessage("|cFF956D41table debug|r |cFF2EA2EC<".. tostring(j) ..">")
            if (type(v) == "table") then
                for j, s in pairs(arg) do
                    if (type(s) == "table") then
                        tabPrint(s)
                    else
                        DEFAULT_CHAT_FRAME:AddMessage("|cFF956D41table debug|r |cFF2EA2EC<".. tostring(i) ..": ".. tostring(j) .." |cFFECE822<".. tostring(s) ..">")
                    end
                end
            else
                DEFAULT_CHAT_FRAME:AddMessage("|cFF956D41table debug|r " ..tostring(i) .." |cFFECE822<".. tostring(v) ..">")
            end
        end
    else
        DEFAULT_CHAT_FRAME:AddMessage("|cFF956D41table debug|r " ..tostring(i) .." |cFFECE822<".. tostring(v) ..">")
    end
end
